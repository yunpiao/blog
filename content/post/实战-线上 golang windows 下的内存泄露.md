---
title: å®æˆ˜-çº¿ä¸Š golang windows ä¸‹çš„å†…å­˜æ³„éœ²
tags:
  - çº¿ä¸Šå®æˆ˜
  - go
  - cgo
date: 2024-04-25T15:28:36+08:00
draft: false
toc: true
slug: 20240425152836
feature:
---

<!--more-->
## 1. èƒŒæ™¯
ä»Šå¤©é‡åˆ°äº†ä¸€ä¸ªå®¢æˆ·é—®é¢˜, ç”¨æˆ·è¯´æˆ‘ä»¬è¿™è¾¹çš„ç¨‹åºå ç”¨çš„å†…å­˜è¶Šæ¥è¶Šå¤š, æˆ‘ä»¬çš„ç¨‹åºæ˜¯é€šè¿‡ windows server æ‰˜ç®¡çš„, ä½¿ç”¨ golang ç¼–è¯‘æˆ exe å, ä½¿ç”¨å®‰è£…å™¨å®‰è£…åˆ°ç”¨æˆ· windows æœåŠ¡å™¨ä¸Šçš„, ç†è®ºä¸Šåªæ˜¯ä¸€ä¸ªå¿ƒè·³ + ä¿¡æ¯æ”¶é›†ç”¨çš„, ä¸ä¼šå ç”¨å¤ªå¤šå†…å­˜. 

ä¸è¿‡å½“çœ‹åˆ°ç”¨æˆ· 64G å†…å­˜é©¬ä¸Šæ»¡äº†ä¹‹å, æ„è¯†åˆ°è‚¯å®šæ˜¯å“ªé‡Œå‡ºäº†é—®é¢˜ ğŸ˜±

## 2. å¤ç°æ­¥éª¤
æ‰¾äº†å…¬å¸é‡Œé¢å‡ å°å®‰è£…çš„æ¯”è¾ƒä¹…çš„ exe çœ‹äº†ä¸‹, è¿è¡Œä¸€ä¸¤ä¸ªæœˆå, å†…å­˜ç¡®å®åˆ°äº† 1 G å·¦å³. ğŸ˜‚ è¿™ä¸ªæ—¶å€™åªèƒ½ä¸€æ­¥ä¸€æ­¥æ’æŸ¥å“ªé‡Œå‡ºé—®é¢˜äº†

### æ’æŸ¥ç¬¬ä¸€æ­¥
é¦–å…ˆæƒ³åˆ°çš„æ˜¯ Pprof ç¥å™¨, `fmt.Println(http.ListenAndServe("0.0.0.0:6063", nil))` ä¸€æŠŠæ¢­ä¹‹å, dump æŸ¥çœ‹å†…å­˜å ç”¨
![image.png](https://img.yunpiao.site/2024/04/8a504070cec1b40230b963234e228b9c.png)
ä¸€é¡¿æ“ä½œçŒ›å¦‚è™, ä¸€çœ‹å†…å­˜å‡ ç™¾K, è¿™ä»€ä¹ˆéƒ½æ²¡æœ‰

æƒ³åˆ°å¯èƒ½æ˜¯ä½¿ç”¨äº† CGO, è¿™éƒ¨åˆ†å†…å­˜æ˜¯æ²¡åŠæ³•åœ¨ pprof ä¸­è§‚å¯Ÿåˆ°çš„, äºæ˜¯å¼€å¯äº†ç¬¬äºŒæ­¥

### æ’æŸ¥ç¬¬äºŒæ­¥
ç¥å™¨ windbg, æƒ³åˆ°å¯ä»¥è½¬å‚¨å†…å­˜, ä¹‹åé€šè¿‡åˆ†æå†…å­˜ä¸­çš„å†…å®¹, å°±å¯ä»¥çŸ¥é“éƒ½æ˜¯é‚£äº›å†…å®¹å æ®çš„å†…å­˜äº†
é¦–å…ˆè½¬å‚¨å†…å­˜, ç›´æ¥åœ¨ä»»åŠ¡ç®¡ç†å™¨ä¸­æ“ä½œè½¬å‚¨
![image.png](https://img.yunpiao.site/2024/04/2d0917cc85ea0215e3df0fbcdc9682ab.png)

ä¸‹è½½ windbg, å¹¶æ‰“å¼€è½¬å‚¨æ–‡ä»¶
https://learn.microsoft.com/zh-cn/windows-hardware/drivers/debugger/ å¯ä»¥ä»å¾®è½¯è¿™é‡Œä¸‹è½½, ä¸è¿‡è¿™ä¸ªç‰ˆæœ¬æ¯”è¾ƒæ–°äº†, ä¸€äº›å‘½ä»¤å¯èƒ½ä¸æ—§ç‰ˆæœ¬ä¸å…¼å®¹, æˆ‘æ˜¯ google ä¸‹è½½çš„ä¹‹å‰ç‰ˆæœ¬

![image.png](https://img.yunpiao.site/2024/04/8804be6b3c0fae9403f3cc50a8bf0c4b.png)
#### åˆ†æå‰çš„ windbg é…ç½®å·¥ä½œ
åˆ†æå‰, éœ€è¦å°† window çš„ç¬¦å·é…ç½®è·¯å¾„, å¯ä»¥åœ¨ windbg ä¸­è¾“å…¥ä¸‹é¢çš„å‘½ä»¤è¿›è¡ŒåŠ è½½
```powershell
.sympath SRV*c:\mySymbols*http://msdl.microsoft.com/download/symbols
!sym noisy
.reload
```

ç„¶ååŠ è½½è½¬å‚¨æ–‡ä»¶ä½¿ç”¨å¦‚ä¸‹çš„å‘½ä»¤è¿›è¡Œåˆ†æ

å¸¸ç”¨çš„ windbg å‘½ä»¤
```bash
!analyse -v å…ˆå¤§è‡´åˆ†æä¸‹


!heap -s æŸ¥çœ‹å†…å­˜åˆ†å¸ƒ
0:000> !heap -s
LFH Key                   : 0x311c1eaa657dc8ce
Termination on corruption : ENABLED
          Heap     Flags   Reserv  Commit  Virt   Free  List   UCR  Virt  Lock  Fast 
                            (k)     (k)    (k)     (k) length      blocks cont. heap 
-------------------------------------------------------------------------------------
0000000001980000 00000002   32552  20420  32552    479   896     6    0      2   LFH
0000000000010000 00008000      64      4     64      2     1     1    0      0      
0000000000320000 00001002    7216   3236   7216     37     6     4    0      6   LFH
0000000028670000 00001002      60     16     60      5     2     1    0      0      
00000000287f0000 00001002      60      8     60      5     1     1    0      0      
-------------------------------------------------------------------------------------


!heap -stat -h 0000000001980000 å‚çœ‹Heap
    size     #blocks     total     ( %) (percent of total busy bytes)
    118 d - e38  (20.12)
    8e4 1 - 8e4  (12.58)
    800 1 - 800  (11.32)
    400 2 - 800  (11.32)
    782 1 - 782  (10.62)
    50 f - 4b0  (6.63)
    410 1 - 410  (5.75)
    238 1 - 238  (3.14)
    1e0 1 - 1e0  (2.65)
    1b0 1 - 1b0  (2.39)
    20 a - 140  (1.77)
    100 1 - 100  (1.41)
    68 2 - d0  (1.15)
    3e 3 - ba  (1.03)
    98 1 - 98  (0.84)
    30 3 - 90  (0.80)
    44 2 - 88  (0.75)
    42 2 - 84  (0.73)
    40 2 - 80  (0.71)
    3c 2 - 78  (0.66)

!heap -flt s 118 æŸ¥çœ‹ 118 å¤§å°çš„æ•°æ®é‡Œé¢æœ‰ä»€ä¹ˆ, ä»€ä¹ˆéƒ½æ²¡çœ‹å‡ºæ¥
    _HEAP @ 1980000
              HEAP_ENTRY Size Prev Flags            UserPtr UserSize - state
        00000000019819d0 0012 0000  [00]   00000000019819e0    00118 - (busy)
        0000000001981b50 0012 0012  [00]   0000000001981b60    00118 - (busy)
        0000000001981fc0 0012 0012  [00]   0000000001981fd0    00118 - (busy)
        0000000001982140 0012 0012  [00]   0000000001982150    00118 - (busy)
        0000000001982380 0012 0012  [00]   0000000001982390    00118 - (busy)
        0000000001983090 0012 0012  [00]   00000000019830a0    00118 - (busy)
        00000000019832c0 0012 0012  [00]   00000000019832d0    00118 - (busy)
        0000000001983520 0012 0012  [00]   0000000001983530    00118 - (busy)
        0000000001983730 0012 0012  [00]   0000000001983740    00118 - (busy)
        0000000001984650 0012 0012  [00]   0000000001984660    00118 - (busy)
        0000000001984cf0 0012 0012  [00]   0000000001984d00    00118 - (busy)
        0000000001984fa0 0012 0012  [00]   0000000001984fb0    00118 - (busy)
        0000000001987640 0012 0012  [00]   0000000001987650    00118 - (busy)
    _HEAP @ 10000
    _HEAP @ 320000
    _HEAP @ 28670000
    _HEAP @ 287f0000

```
ğŸ¥² çœ‹äº†ä¸‹ åˆ†å¸ƒå¾ˆå‡åŒ€, çœ‹ä¸å‡ºæ¥åˆ°åº•æ˜¯é‚£ç§ç±»å‹æ•°æ®, ä¼¼ä¹æ²¡æœ‰æœ‰ç”¨çš„ç‰¹å¾ä¿¡æ¯, æ¨æ–­å¯èƒ½æ˜¯å†…æ ¸æ€çš„è¿›ç¨‹äº†, å¤ªè´¹äº‹äº†, äºæ˜¯æƒ³åˆ°äº†ä¸‡èƒ½çš„ç¬¨æ–¹æ³•

### æ’æŸ¥ç¬¬ä¸‰æ­¥ é€æ­¥å°è¯•,  æŸ¥çœ‹å“ªä¸ªå‡½æ•°æ¶ˆè€—çš„å†…å­˜
ç”±äºä»£ç é‡ä¸å¤§, ç›¸å…³çš„ cgo å‡½æ•°å°±é‚£ä¹ˆå‡ ä¸ª. æ‰€ä»¥å¯ä»¥ç›´æ¥éå†, å®šä½å†…å­˜æ³„éœ²å‡½æ•°

```go
for i := 0; i < 10000000; i++ {
	fmt.Printf("TestXXX: %#v\n", getXXX())
	fmt.Printf("TestXXX: %#v\n", getXXX1())
	fmt.Printf("TestXXX: %#v\n", getXXX2())
}
```
å†™ä¸€ä¸ªå•æµ‹, ç›´æ¥è¿è¡Œ, æŸ¥çœ‹å†…å­˜å˜åŒ–
æœ€åç¡®å®å®šä½åˆ°äº†é—®é¢˜ç‚¹,  ç¨‹åºä¸­ä½¿ç”¨äº† `# DsGetDomainControllerInfoW` å‡½æ•°, ä½¿ç”¨äº†ç³»ç»Ÿè°ƒç”¨å»è·å–äº† windows server çš„ä¿¡æ¯, ä½†æ˜¯ä¿¡æ¯æ˜¯ dll ä¸­ç”³è¯·çš„, golang è¿™è¾¹ç®¡ç†ä¸äº†, åç»­è¦æ‰‹åŠ¨ä½¿ç”¨ `# DsFreeDomainControllerInfoW` ç³»ç»Ÿè°ƒç”¨æ‰‹åŠ¨é‡Šæ”¾, ğŸ˜’ çœŸæ˜¯ fuck, ä¸è¿‡å¥½åœ¨è¿™éƒ¨åˆ†ä»£ç ä¸æ˜¯æˆ‘å†™çš„, å¯ä»¥ç”©é”… ğŸ˜

å…·ä½“çš„å‡½æ•°ä½¿ç”¨è¯´æ˜ https://learn.microsoft.com/zh-cn/windows/win32/api/ntdsapi/nf-ntdsapi-dsgetdomaincontrollerinfoa


## 3. windows ä¸‹è¿›ç¨‹å†…å­˜çš„è§‚æµ‹æ–¹æ³•
### 3.1. windows è‡ªå¸¦æ€§èƒ½ç›‘è§†å™¨
![image.png](https://img.yunpiao.site/2024/04/c92d19e2f758f5279d15cc45dacbd45c.png)
![image.png](https://img.yunpiao.site/2024/04/d5122413822424eb971b279002d3fecd.png)
ä¸€èˆ¬æ¥è¯´, è‡ªå¸¦çš„å·²ç»å¯ä»¥äº†, ä½†æ˜¯ä¸è¶³ä¹‹å¤„æ˜¯, æ— æ³•æŸ¥çœ‹å…·ä½“çš„æ•°å€¼, åªæœ‰ç»Ÿè®¡å€¼

### 3.2. ä½¿ç”¨ windows exporter æŸ¥çœ‹è¿›ç¨‹çŠ¶æ€
https://github.com/prometheus-community/windows_exporter
ç›´æ¥ä» release ä¸‹è½½æœ€æ–°ç‰ˆæœ¬, åœ¨ windows ä¸Šè¿è¡Œ, æ³¨æ„é»˜è®¤æƒ…å†µä¸‹, æ˜¯ä¸ä¼šç›‘æ§è¿›ç¨‹ç›¸å…³çš„æŒ‡æ ‡çš„, éœ€è¦åœ¨å¯åŠ¨å‘½ä»¤ä¸­å¢åŠ ç›¸å…³å‚æ•°

å¯åŠ¨å‘½ä»¤
```bash
.\windows_exporter.exe --collectors.enabled "process" --collector.process.include="firefox.+"
```

é»˜è®¤çš„é‡‡é›†ç«¯æ˜¯ 9182, åœ¨ prometheus ä¸­é…ç½®é‡‡é›†å¯¹è±¡

prometheus.yml
```yaml
global:
  scrape_interval:     60s
  evaluation_interval: 60s
 
scrape_configs:
  - job_name: prometheus
    static_configs:
      - targets: ['localhost:9182']
        labels:
          instance: prometheus
```

æœ€ååœ¨ grafana ä¸­è§‚å¯Ÿå°±å¯ä»¥çœ‹åˆ°æŒ‡å®šè¿›ç¨‹çš„å†…å­˜å ç”¨æƒ…å†µ
![image.png](https://img.yunpiao.site/2024/04/beedd3c83ac4b8311a922d34038c1f00.png)

å…·ä½“çš„æŒ‡æ ‡é¡¹ä¸º `windows_process_working_set_private_bytes`, é€šè¿‡ grafana å¯ä»¥åªç®¡æŸ¥çœ‹åˆ°å…·ä½“çš„å†…å­˜å ç”¨æ•°æ®

