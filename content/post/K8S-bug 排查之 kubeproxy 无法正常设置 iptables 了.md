---
title: K8S-bugæ’æŸ¥ä¹‹ kubeproxy æ— æ³•æ­£å¸¸è®¾ç½® iptables äº†
tags:
  - é—®é¢˜æ’æŸ¥
  - k8s
  - ç½‘ç»œ
date: 2025-09-11T14:18:44+08:00
draft: false
toc: true
slug: 20250911141844
categories:
---
> ğŸ˜§ ç¨€å¥‡å¤æ€ªçš„ bug æ€ä¹ˆè¿™ä¹ˆå¤š, è¿˜å¥½æ˜¯ä¸€ä¸ªå‰äººé‡åˆ°è¿‡çš„, å¦‚æœæˆ‘æ˜¯ç¬¬ä¸€ä¸ªå‘ç°çš„, ä¼°è®¡ç¾å¥½çš„å‘¨äº”æ™šä¸Šå°±æ²¡æœ‰äº†


### 1. èƒŒæ™¯ 

å³å°†ä¸‹ç­çš„å‘¨äº”ä¸‹åˆ 5 ç‚¹, è¿ç»´ä¸åˆæ—¶å®œçš„ç”©ç»™æˆ‘äº†ä¸€ä¸ªå›¾ç‰‡,  è¿™æ¬¡å¥½ä¸€äº›, åŠ äº†ä¸€æ®µæ–‡å­—, è¯´ç”¨æˆ·åšäº†ä¸‹è¿ç§», ç„¶åå‘ç°æœåŠ¡å¯åŠ¨å redis æœåŠ¡å¼‚å¸¸, å¸è½½é‡è£…å¤§æ³•ä¹Ÿä¸å¥½ä½¿,
redis ha ä½¿ç”¨ helm éƒ¨ç½²çš„æ—¶å€™, åªæœ‰ä¸€ä¸ªæ­£å¸¸, å‰©ä¸‹çš„ä¸¤ä¸ª redis pod å¯åŠ¨åæ— æ³•è¿æ¥åˆ° master çš„ redis pod. 

**ç¯å¢ƒè¯´æ˜**
- å…¬å¸ç§æœ‰åŒ–éƒ¨ç½²åˆ°å®¢æˆ·çš„ k8s ç¯å¢ƒ v1.26
- ä½¿ç”¨ redis-ha éƒ¨ç½² redis, å“¨å…µæ¨¡å¼
### 2. ç°è±¡
- slave çš„ redis pod è¿æ¥ redis çš„æ—¶å€™ä½¿ç”¨ dns è§£æçš„ redis cluster ip æœ‰é—®é¢˜, è¿˜æ˜¯ä¸Šä¸€ç‰ˆæœ¬çš„ redis services  ip

### 3. é€æ­¥æ’æŸ¥
#### èµ·åˆæ€€ç–‘æ˜¯ dns çš„é—®é¢˜, dns è®°å½•æ²¡æœ‰æ›´æ–°, 
æ–°å»º service å cluster ip æ›´æ–°æ²¡æœ‰é—®é¢˜, å¯ä»¥åˆ¤æ–­ä¸æ˜¯ dns çš„é—®é¢˜

#### é€æ­¥æ£€æŸ¥ k8s ç»„ä»¶
æ£€æŸ¥åˆ° kube proxy èŠ‚ç‚¹çš„æ—¥å¿—çš„ä¹‹å, å‘ç°æ—¥å¿—ä¸­æœ‰é”™è¯¯, å‘ç°èŠ‚ç‚¹ä¸Šæ‰¾ä¸åˆ° `conntrack` `ipset` äºŒè¿›åˆ¶æ–‡ä»¶, åŸå…ˆè®¾ç½®çš„ ipvs æ¨¡å¼é™çº§åˆ°äº† iptables æ¨¡å¼äº†

**`conntrack` `ipset`** äºŒè¿›åˆ¶ç¼ºå¤±

æœ¬æ¥æ˜¯æ²¡å•¥é—®é¢˜, iptables å°± iptables å§, æ¯•ç«ŸæœåŠ¡æ²¡å¤šå°‘ä¸ª, æ€§èƒ½æ˜¯æ²¡å•¥é—®é¢˜çš„, ä¸è¿‡æ—¢ç„¶é‡åˆ°äº†å°±å…ˆè§£å†³ä¸‹
**ä»å…¶ä»–åœ°æ–¹æ‹·è´ conntrack ipset äºŒè¿›åˆ¶åé‡å¯ kube-proxy. ipvsadm æ£€æŸ¥åå‘ç°æ­£å¸¸äº†**

é‡å¯åå‘ç°æŠ¥é”™å˜äº†, ä¸€æ¡æ—¥å¿—å äº†åŠå±, åé¢è¿˜æœ‰å…¶ä»–é”™è¯¯æ—¥å¿—æ²¡å‘ç°, è¿™ä¸ªé”™è¯¯æ¶ˆé™¤å, å‘ç°äº†å¯ä»¥å®šä½ bug çš„æ—¥å¿—

> å…„å¼Ÿä»¬, æœ‰æ—¶å€™å°±æ˜¯è¿™æ ·, ä½ åªçœ‹åˆ°äº†é”™è¯¯æ—¥å¿—, ä½ ä»¥ä¸ºæ‰¾åˆ°äº†`è§£å†³é—®é¢˜çš„é‡‘æ‰‹æŒ‡` ä½†å…¶å®ä½ çœ‹åˆ°çš„æ˜¯ä¸ªçƒŸé›¾å¼¹

```bash
I1113 16:15:07.928773 1 proxier.go:1464] "Reloading service iptables data" numServices=0 numEndpoints=0 numFilterChains=4 numFilterRules=3 numNATChains=4 numNATRules=5
E1113 16:15:07.931291 1 proxier.go:1481] "Failed to execute iptables-restore" err=<
exit status 2: ip6tables-restore v1.8.4 (legacy): unknown option "--xor-mark"
Error occurred at line: 16
Try `ip6tables-restore -h' or 'ip6tables-restore --help' for more information.
>
I1113 16:15:07.931308 1 proxier.go:858] "Sync failed" retryingTime="30s"
I1113 16:15:07.931317 1 proxier.go:820] "SyncProxyRules complete" elapsed="22.67239ms"
```
 çœ‹åˆ°ç¬¬ä¸€ååº”, `unknown option "--xor-mark" ` iptables ç‰ˆæœ¬å¤ªè€çš„, ä¸æ”¯æŒè¿™ä¸ªå‘½ä»¤, æˆ–è€… mod æ²¡åŠ è½½,  æ£€æŸ¥äº†ä¸€é, å‘ç°ç‰ˆæœ¬ä¹Ÿæ˜¯æ–°çš„, ko mod ä¹ŸåŠ è½½äº†, ç¥å¥‡, è€Œä¸”æ—¥å¿—ä¸­æç¤ºä½¿ç”¨çš„ç¡®å®æ˜¯ 1.8.4 ç‰ˆæœ¬çš„ iptables. **çœŸè§é¬¼äº† å…„å¼Ÿä»¬**

éšåæˆ‘æƒ³ç€ä¼šä¸ä¼šå°±è¿™æ ·çš„å‘¢? è¿™ä¸ªçœ‹ç€æ˜¯ä¸ª error, å…¶å®æ˜¯ä¸ª warning å‘¢? æ¯•ç«ŸæœåŠ¡è¿æ¥ es è¿™äº›æ˜¯æ­£å¸¸çš„å•Š
#### åæ€, ä¸æ­£å¸¸, ååˆ†æœ‰åäºŒåˆ†çš„ä¸æ­£å¸¸
å›åˆ°é—®é¢˜åŸç‚¹
1. éƒ¨ç½² redis
2. redis-master å¯åŠ¨æ²¡æœ‰é—®é¢˜
3. redis-slave1 å¯åŠ¨æ²¡æœ‰é—®é¢˜
4. redis-slave2 å¯åŠ¨æ•…éšœ, è¿æ¥ master æç¤ºè¶…æ—¶, 
5. ç™»å½•åˆ° slave2 æœºå™¨ä¸Šå‘ç° telnet ç¡®å®ä¸é€š, æŸ¥çœ‹ ipvs ç¡®å®æ²¡æœ‰æ¡ç›®, ç¡®å®æ˜¯è¿™ä¸ªç›´æ¥åŸå› 

> åˆ†æ, slave1 å¯ä»¥é€šè¿‡ cluster è¿æ¥åˆ° redis master, slave2 å‘ç°è¿æ¥ä¸ä¸Š, é¦–å…ˆè¯æ˜ master æ˜¯æ²¡é—®é¢˜çš„, è¿˜æ˜¯ ipvs æ¡ç›®åˆ›å»ºçš„é—®é¢˜, ipvs æ˜¯ç”± kube proxy ç›´æ¥ç®¡ç†çš„, é—®é¢˜è¿˜æ˜¯åœ¨ kubeproxy

6. å°è¯•å°†ä¸šåŠ¡æœåŠ¡ç§»åŠ¨åˆ° master è¯•ä¸€ä¸‹, å› ä¸ºå‡ºç°é—®é¢˜çš„éƒ½åœ¨ä¸¤å° worker èŠ‚ç‚¹ä¸Š, 
7. å°†è¿™ä¸¤å°æœºå™¨ cordon å, åˆ äº†ä¸šåŠ¡ pod
8. åŸå…ˆå¯åŠ¨æŠ¥é”™è¿æ¥ä¸åˆ° redis, ç§»åŠ¨åå¯ä»¥æ­£å¸¸å¯åŠ¨äº†
9. æ£€æŸ¥ç°åœ¨ç§»åŠ¨åˆ°çš„è¿™ä¸ªèŠ‚ç‚¹å’Œä¹‹å‰æœ‰é—®é¢˜çš„èŠ‚ç‚¹æœ‰ä»€ä¹ˆä¸ä¸€è‡´çš„
10. éƒ¨ç½²æœåŠ¡å…¨éƒ¨éƒ½æ˜¯ä¸€è‡´çš„, ä½†æ˜¯æ­£å¸¸æœºå™¨æ˜¯æ²¡æœ‰æŠ¥ ip6tables-restore è¿™ä¸ªé”™è¯¯çš„
11. ä¸ç»æ„å¯¹æ¯”åˆ°å†…æ ¸ç‰ˆæœ¬çš„æ—¶å€™å‘ç°é—®é¢˜äº† 

![image.png](https://img.yunpiao.site/2025/09/4c10a8a3e0168c4fc4348f51428c5a81.png)
`æ‰¾åˆ°ä¸€ä¸ªååˆ†åƒé—®é¢˜ç‚¹çš„ä¸åŒ, å†…æ ¸ç‰ˆæœ¬æœ‰å·®åˆ«`
### 4. å®šä½åŸå› 
#### google å¤§æ³•
'`unknown option "--set-mark"` å‘ç°ç¡®å®å¥½åƒæœ‰äº›çœ‰ç›®é¢, éš¾é“å°±æ˜¯å†…æ ¸çš„ bug å— ? 
ç¡®å®æ˜¯çš„, å†…æ ¸çš„é”…, ä¸Šä¸€å¹´ 12 æœˆ, ä¹Ÿç®—æ˜¯ä¸€ä¸ªæ–°é²œçš„ bug, è¿™ç§äº‹ä¸ºä»€ä¹ˆå‘ç”Ÿåœ¨æˆ‘èº«ä¸Š, æˆ‘æ˜¯æ˜“ bug ä½“è´¨å—?

![image.png](https://img.yunpiao.site/2025/09/8d8295c7a5bd517627cbbc8197d990bd.png)

#### æ ¹æœ¬åŸå› ï¼ˆRoot Causeï¼‰ï¼šä¸€ä¸ªæœ‰ç¼ºé™·çš„å†…æ ¸æäº¤
æŠ¥å‘Šä¸­æ˜ç¡®æŒ‡å‡ºäº†å¯¼è‡´è¿™ä¸ªé—®é¢˜çš„â€œç½ªé­ç¥¸é¦–â€ï¼šä¸€ä¸ªç‰¹å®šçš„å†…æ ¸æäº¤ï¼ˆcommitï¼‰ã€‚
- **Commit ID:**Â 862c95d9859f
- **Commit æ ‡é¢˜:**Â netfilter: xt_mark: reject MARK target with mask
**è¿™ä¸ªæäº¤çš„æ„å›¾æœ¬æ¥æ˜¯å¥½çš„ï¼Œä½†å®ç°æ˜¯é”™è¯¯çš„ã€‚**
- **åŸæœ¬çš„æ„å›¾ï¼š**Â è¯¥æäº¤çš„ä½œè€…å¯èƒ½æƒ³è¦å¢åŠ ä¸€ä¸ªæ£€æŸ¥ï¼Œä»¥é˜²æ­¢ç”¨æˆ·è®¾ç½®ä¸€ä¸ªæ— æ•ˆçš„ mark/mask ç»„åˆã€‚ä¾‹å¦‚ï¼Œ--set-mark 0x10/0x1Â å°±æ˜¯æ— æ•ˆçš„ï¼Œå› ä¸º mark çš„å€¼ (0x10) ä¸­åŒ…å«çš„ä½è¶…å‡ºäº†æ©ç  (0x1) çš„èŒƒå›´ã€‚
- **é”™è¯¯çš„ç»“æœï¼š**Â ç„¶è€Œï¼Œä»£ç çš„å®ç°è¿‡äºâ€œæ¿€è¿›â€å’Œç®€å•ç²—æš´ï¼Œå®ƒç›´æ¥**ç¦æ­¢äº†æ‰€æœ‰ä½¿ç”¨æ©ç çš„Â MARKÂ ç›®æ ‡**ï¼Œæ— è®ºè¿™ä¸ªç»„åˆæ˜¯å¦æœ‰æ•ˆã€‚è¿™ç ´åäº†ä¸€ä¸ªå·²ç»å­˜åœ¨äº†å¾ˆé•¿æ—¶é—´å¹¶ä¸”è¢«å¹¿æ³›ä½¿ç”¨çš„åˆæ³•åŠŸèƒ½ã€‚
è¿™æ˜¯ä¸€ä¸ªå…¸å‹çš„**å›å½’ Bug (Regression Bug)**ï¼šä¸ºäº†ä¿®å¤æˆ–æ”¹è¿›æŸä¸ªä¸œè¥¿è€Œå¼•å…¥çš„æ–°ä»£ç ï¼Œå´æ„å¤–åœ°ç ´åäº†å¦ä¸€ä¸ªåŸæœ¬æ­£å¸¸å·¥ä½œçš„åŠŸèƒ½
#### å½±å“èŒƒå›´
è¿™ä¸ª Bug çš„å½±å“éå¸¸å¹¿æ³›ï¼Œå› ä¸ºå®ƒä»å†…æ ¸å±‚é¢ç›´æ¥ç¦ç”¨äº†Â MARKÂ ç›®æ ‡çš„ä¸€ä¸ªæ ¸å¿ƒåŠŸèƒ½ã€‚
- **Kubernetes (K8s):**Â kube-proxyÂ åœ¨ IPVS æ¨¡å¼ä¸‹ä¸¥é‡ä¾èµ–Â --set-mark 0x4000/0x4000Â è¿™æ ·çš„è¯­æ³•æ¥æ ‡è®°éœ€è¦åš SNAT çš„æµé‡ã€‚å½“å†…æ ¸æ‹’ç»è¿™æ¡è§„åˆ™æ—¶ï¼Œkube-proxyÂ çš„åŒæ­¥å¾ªç¯å°±ä¼šå¤±è´¥ï¼Œå¯¼è‡´å…¶é™·å…¥Â CrashLoopBackOffã€‚
- **Tailscale:**Â æ­£å¦‚æŠ¥å‘Šä¸­æåˆ°çš„ï¼ŒTailscaleÂ ä¹Ÿä½¿ç”¨ç±»ä¼¼çš„è§„åˆ™æ¥æ ‡è®°æµé‡ï¼Œå› æ­¤ä¹Ÿä¼šåœ¨è¿™ä¸ªæœ‰é—®é¢˜çš„å†…æ ¸ç‰ˆæœ¬ä¸Šè¿è¡Œå¤±è´¥ã€‚
- **å…¶ä»–ç½‘ç»œè½¯ä»¶:**Â ä»»ä½•ä¾èµ–Â iptablesÂ mark æ©ç åŠŸèƒ½çš„é˜²ç«å¢™è„šæœ¬ã€ç½‘ç»œå·¥å…·æˆ– CNI æ’ä»¶éƒ½ä¼šå—åˆ°å½±å“ã€‚
- **å—å½±å“çš„ç³»ç»Ÿ:**
    - **Ubuntu 24.04 (Noble Numbat)**ï¼Œå› ä¸ºå®ƒé»˜è®¤æ­è½½äº†å—å½±å“çš„ Linux 6.8 å†…æ ¸ã€‚
    - **Ubuntu 22.04 LTS (Jammy Jellyfish)**Â ç­‰æ—§ç‰ˆæœ¬ï¼Œå¦‚æœç”¨æˆ·å®‰è£…äº†Â **HWE (Hardware Enablement) å†…æ ¸**ï¼Œå†…æ ¸ç‰ˆæœ¬ä¹Ÿä¼šå‡çº§åˆ°å—å½±å“çš„ç‰ˆæœ¬ï¼Œä»è€Œå¼•å…¥è¿™ä¸ªé—®é¢˜ã€‚

### 5. åˆ†ææ—¥å¿—å‡ºé”™ç‚¹
```go
	// --------------------------------------------------------------------------
	// åº”ç”¨å˜æ›´åˆ°ç³»ç»Ÿ
	// --------------------------------------------------------------------------

	// å°†å†…å­˜ä¸­ `activeEntries` çš„å˜æ›´åŒæ­¥åˆ° ipset å†…æ ¸ä¸­ã€‚
	// è¿™ä¸ªå‡½æ•°ä¼šè®¡ç®—å·®å¼‚ï¼Œå¹¶è°ƒç”¨ `ipset` å‘½ä»¤æ¥æ·»åŠ æˆ–åˆ é™¤æ¡ç›®ã€‚
	for _, set := range proxier.ipsetList {
		set.syncIPSetEntries()
	}

	// ä¸º ipset ç”Ÿæˆç›¸å…³çš„ iptables è§„åˆ™ (ä¾‹å¦‚ï¼ŒåŒ¹é… ipset çš„è§„åˆ™)ã€‚
	proxier.writeIptablesRules()

	// å‡†å¤‡æœ€ç»ˆçš„ iptables-restore æ•°æ®ã€‚
	proxier.iptablesData.Reset()
	proxier.iptablesData.Write(proxier.natChains.Bytes())
	proxier.iptablesData.Write(proxier.natRules.Bytes())
	proxier.iptablesData.Write(proxier.filterChains.Bytes())
	proxier.iptablesData.Write(proxier.filterRules.Bytes())

	klog.V(5).Infof("Restoring iptables rules: %s", proxier.iptablesData.Bytes())
	// è¿™æ˜¯æ•´ä¸ª iptables åŒæ­¥è¿‡ç¨‹ä¸­æœ€æ ¸å¿ƒçš„åŸå­æ“ä½œã€‚
	// æ‰€æœ‰ä¹‹å‰åœ¨å†…å­˜ä¸­æ„å»ºå¥½çš„ iptables è§„åˆ™ï¼ˆå­˜å‚¨åœ¨ proxier.iptablesData ä¸­ï¼‰
	// é€šè¿‡ `iptables-restore` å‘½ä»¤ä¸€æ¬¡æ€§ã€åŸå­åœ°åº”ç”¨åˆ°ç³»ç»Ÿä¸­ã€‚
	// `utiliptables.NoFlushTables` é€‰é¡¹å‘Šè¯‰ `iptables-restore` ä¸è¦æ¸…é™¤è¡¨ä¸­å·²æœ‰çš„ã€é kube-proxy ç®¡ç†çš„è§„åˆ™ã€‚
	err = proxier.iptables.RestoreAll(proxier.iptablesData.Bytes(), utiliptables.NoFlushTables, utiliptables.RestoreCounters)
	if err != nil {
		klog.Errorf("Failed to execute iptables-restore: %v\nRules:\n%s", err, proxier.iptablesData.Bytes())
		// å¦‚æœ iptables-restore å¤±è´¥ï¼Œéœ€è¦å›æ»šæ–°æ‰“å¼€çš„ç«¯å£ï¼Œä»¥é¿å…èµ„æºæ³„æ¼ã€‚
		utilproxy.RevertPorts(replacementPortsMap, proxier.portsMap)
		return
	}

```

### 6. è§£å†³æ–¹æ³•
ç”±äºæˆ‘æ²¡æœ‰ç›´æ¥æ¥è§¦å®¢æˆ·, ä¸è¿‡ç”¨è„šè¶¾å¤´æƒ³äº†ä¸‹, ç”¨æˆ·è¯´çš„è¿ç§», å…¶å®æ˜¯å·å·å‡çº§äº† linux å†…æ ¸, ä½†æ˜¯å‡çº§æ“ä½œè¿˜ä¸ç»Ÿä¸€, å°ç‰ˆæœ¬ä¸ä¸€è‡´, æ‰€ä»¥é€ æˆäº† master çš„å†…æ ¸æ˜¯å¥½çš„, worker èŠ‚ç‚¹çš„å†…æ ¸æ˜¯ bug ç‰ˆæœ¬çš„
åé¦ˆç»™å®¢æˆ·äº†, è®©ç”¨æˆ·å‡çº§å†…æ ¸è§£å†³äº†

### å‚è€ƒé“¾æ¥
https://github.com/rancher/rke2/issues/7438 
https://bugs.launchpad.net/ubuntu/+source/linux/+bug/2091990
https://github.com/kubernetes/kubernetes/blob/v1.14.10/pkg/proxy/ipvs/proxier.go#L721

<!--more-->